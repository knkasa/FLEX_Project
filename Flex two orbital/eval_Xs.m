function C = eval_Xs( U, X, dim );

% dim = size(Xs0) will suffice
%  susceptibility spin  

%  I - U*Xs0
I = ones( dim(1),dim(2),dim(3) );
a = zeros(dim);
det = zeros(dim(1),dim(2),dim(3) );
B = zeros(dim);
C = zeros(dim);

I = ones( dim(1),dim(2),dim(3) );


a(:,:,:,1,1) = I - U(1,4)*X(:,:,:,1,4) - U(1,1)*X(:,:,:,1,1);
a(:,:,:,1,2) = -U(1,1)*X(:,:,:,1,2) - U(1,4)*X(:,:,:,2,4);
a(:,:,:,1,3) = -U(1,1)*X(:,:,:,1,3) - U(1,4)*X(:,:,:,3,2);
a(:,:,:,1,4) = -U(1,1)*X(:,:,:,1,4) - U(1,4)*X(:,:,:,4,4);

a(:,:,:,2,1) = -U(2,2)*X(:,:,:,1,2) - U(2,3)*X(:,:,:,1,3);
a(:,:,:,2,2) = I - U(2,3)*X(:,:,:,2,3) - U(2,2)*X(:,:,:,2,2);
a(:,:,:,2,3) = -U(2,2)*X(:,:,:,2,3) - U(2,3)*X(:,:,:,3,3);
a(:,:,:,2,4) = -U(2,2)*X(:,:,:,2,4) - U(2,3)*X(:,:,:,3,4);

a(:,:,:,3,1) = -U(2,2)*X(:,:,:,1,3) - U(2,3)*X(:,:,:,1,2);
a(:,:,:,3,2) = -U(2,2)*X(:,:,:,1,3) - U(2,3)*X(:,:,:,2,2);
a(:,:,:,3,3) = I - U(2,2)*X(:,:,:,3,3) - U(2,3)*X(:,:,:,2,3);
a(:,:,:,3,4) = -U(2,3)*X(:,:,:,2,4) - U(2,2)*X(:,:,:,3,4);

a(:,:,:,4,1) = -U(1,1)*X(:,:,:,1,4) - U(1,4)*X(:,:,:,1,1);
a(:,:,:,4,2) = -U(1,4)*X(:,:,:,1,2) - U(1,1)*X(:,:,:,2,4);
a(:,:,:,4,3) = -U(1,4)*X(:,:,:,1,3) - U(1,1)*X(:,:,:,3,4);
a(:,:,:,4,4) = I - U(1,1)*X(:,:,:,4,4) - U(1,4)*X(:,:,:,1,4);


% this is determinant of 4x4
det(:,:,:) = a(:,:,:,1,1).*a(:,:,:,2,2).*a(:,:,:,3,3).*a(:,:,:,4,4) - a(:,:,:,1,1).*a(:,:,:,2,2).*a(:,:,:,3,4).*a(:,:,:,4,3) - a(:,:,:,1,1).*a(:,:,:,2,3).*a(:,:,:,3,2).*a(:,:,:,4,4) + a(:,:,:,1,1).*a(:,:,:,2,3).*a(:,:,:,3,4).*a(:,:,:,4,2) ...
    + a(:,:,:,1,1).*a(:,:,:,2,4).*a(:,:,:,3,2).*a(:,:,:,4,3) - a(:,:,:,1,1).*a(:,:,:,2,4).*a(:,:,:,3,3).*a(:,:,:,4,2) - a(:,:,:,1,2).*a(:,:,:,2,1).*a(:,:,:,3,3).*a(:,:,:,4,4) + ...
    a(:,:,:,1,2).*a(:,:,:,2,1).*a(:,:,:,3,4).*a(:,:,:,4,3) + a(:,:,:,1,2).*a(:,:,:,2,3).*a(:,:,:,3,1).*a(:,:,:,4,4) - a(:,:,:,1,2).*a(:,:,:,2,3).*a(:,:,:,3,4).*a(:,:,:,4,1) - ...
    a(:,:,:,1,2).*a(:,:,:,2,4).*a(:,:,:,3,1).*a(:,:,:,4,3) + a(:,:,:,1,2).*a(:,:,:,2,4).*a(:,:,:,3,3).*a(:,:,:,4,1) + a(:,:,:,1,3).*a(:,:,:,2,1).*a(:,:,:,3,2).*a(:,:,:,4,4) - ... 
    a(:,:,:,1,3).*a(:,:,:,2,1).*a(:,:,:,3,4).*a(:,:,:,4,2) - a(:,:,:,1,3).*a(:,:,:,2,2).*a(:,:,:,3,1).*a(:,:,:,4,4) + a(:,:,:,1,3).*a(:,:,:,2,2).*a(:,:,:,3,4).*a(:,:,:,4,1) + ... 
    a(:,:,:,1,3).*a(:,:,:,2,4).*a(:,:,:,3,1).*a(:,:,:,4,2) - a(:,:,:,1,3).*a(:,:,:,2,4).*a(:,:,:,3,2).*a(:,:,:,4,1) - a(:,:,:,1,4).*a(:,:,:,2,1).*a(:,:,:,3,2).*a(:,:,:,4,3) + ... 
    a(:,:,:,1,4).*a(:,:,:,2,1).*a(:,:,:,3,3).*a(:,:,:,4,2) + a(:,:,:,1,4).*a(:,:,:,2,2).*a(:,:,:,3,1).*a(:,:,:,4,3) - a(:,:,:,1,4).*a(:,:,:,2,2).*a(:,:,:,3,3).*a(:,:,:,4,1) - ...
    a(:,:,:,1,4).*a(:,:,:,2,3).*a(:,:,:,3,1).*a(:,:,:,4,2) + a(:,:,:,1,4).*a(:,:,:,2,3).*a(:,:,:,3,2).*a(:,:,:,4,1)  ;


% inverse matrix
B(:,:,:,1,1) = (a(:,:,:,2,2).*a(:,:,:,3,3).*a(:,:,:,4,4) - a(:,:,:,2,2).*a(:,:,:,3,4).*a(:,:,:,4,3) - a(:,:,:,2,3).*a(:,:,:,3,2).*a(:,:,:,4,4) + a(:,:,:,2,3).*a(:,:,:,3,4).*a(:,:,:,4,2) ...
    + a(:,:,:,2,4).*a(:,:,:,3,2).*a(:,:,:,4,3) - a(:,:,:,2,4).*a(:,:,:,3,3).*a(:,:,:,4,2) )./det ;

B(:,:,:,2,1) = -(a(:,:,:,2,1).*a(:,:,:,3,3).*a(:,:,:,4,4) - a(:,:,:,2,1).*a(:,:,:,3,4).*a(:,:,:,4,3) - a(:,:,:,2,3).*a(:,:,:,3,1).*a(:,:,:,4,4) + a(:,:,:,2,3).*a(:,:,:,3,4).*a(:,:,:,4,1) ... 
    + a(:,:,:,2,4).*a(:,:,:,3,1).*a(:,:,:,4,3) - a(:,:,:,2,4).*a(:,:,:,3,3).*a(:,:,:,4,1) )./det ;

B(:,:,:,3,1) = (a(:,:,:,2,1).*a(:,:,:,3,2).*a(:,:,:,4,4) - a(:,:,:,2,1).*a(:,:,:,3,4).*a(:,:,:,4,2) - a(:,:,:,2,2).*a(:,:,:,3,1).*a(:,:,:,4,4) + a(:,:,:,2,2).*a(:,:,:,3,4).*a(:,:,:,4,1) ... 
    + a(:,:,:,2,4).*a(:,:,:,3,1).*a(:,:,:,4,2) - a(:,:,:,2,4).*a(:,:,:,3,2).*a(:,:,:,4,1) )./det ;

B(:,:,:,4,1) = -(a(:,:,:,2,1).*a(:,:,:,3,2).*a(:,:,:,4,3) - a(:,:,:,2,1).*a(:,:,:,3,3).*a(:,:,:,4,2) - a(:,:,:,2,2).*a(:,:,:,3,1).*a(:,:,:,4,3) + a(:,:,:,2,2).*a(:,:,:,3,3).*a(:,:,:,4,1) ... 
    + a(:,:,:,2,3).*a(:,:,:,3,1).*a(:,:,:,4,2) - a(:,:,:,2,3).*a(:,:,:,3,2).*a(:,:,:,4,1) )./det ; 

B(:,:,:,1,2) = -(a(:,:,:,1,2).*a(:,:,:,3,3).*a(:,:,:,4,4) - a(:,:,:,1,2).*a(:,:,:,3,4).*a(:,:,:,4,3) - a(:,:,:,1,3).*a(:,:,:,3,2).*a(:,:,:,4,4) + a(:,:,:,1,3).*a(:,:,:,3,4).*a(:,:,:,4,2) ... 
    + a(:,:,:,1,4).*a(:,:,:,3,2).*a(:,:,:,4,3) - a(:,:,:,1,4).*a(:,:,:,3,3).*a(:,:,:,4,2) )./det ; 

B(:,:,:,2,2) = (a(:,:,:,1,1).*a(:,:,:,3,3).*a(:,:,:,4,4) - a(:,:,:,1,1).*a(:,:,:,3,4).*a(:,:,:,4,3) - a(:,:,:,1,3).*a(:,:,:,3,1).*a(:,:,:,4,4) + a(:,:,:,1,3).*a(:,:,:,3,4).*a(:,:,:,4,1) ... 
    + a(:,:,:,1,4).*a(:,:,:,3,1).*a(:,:,:,4,3) - a(:,:,:,1,4).*a(:,:,:,3,3).*a(:,:,:,4,1) )./det ; 

B(:,:,:,3,2) = -(a(:,:,:,1,1).*a(:,:,:,3,2).*a(:,:,:,4,4) - a(:,:,:,1,1).*a(:,:,:,3,4).*a(:,:,:,4,2) - a(:,:,:,1,2).*a(:,:,:,3,1).*a(:,:,:,4,4) + a(:,:,:,1,2).*a(:,:,:,3,4).*a(:,:,:,4,1) ...
    + a(:,:,:,1,4).*a(:,:,:,3,1).*a(:,:,:,4,2) - a(:,:,:,1,4).*a(:,:,:,3,2).*a(:,:,:,4,1) )./det ;

B(:,:,:,4,2) = (a(:,:,:,1,1).*a(:,:,:,3,2).*a(:,:,:,4,3) - a(:,:,:,1,1).*a(:,:,:,3,3).*a(:,:,:,4,2) - a(:,:,:,1,2).*a(:,:,:,3,1).*a(:,:,:,4,3) + a(:,:,:,1,2).*a(:,:,:,3,3).*a(:,:,:,4,1) ... 
    + a(:,:,:,1,3).*a(:,:,:,3,1).*a(:,:,:,4,2) - a(:,:,:,1,3).*a(:,:,:,3,2).*a(:,:,:,4,1) )./det ;

B(:,:,:,1,3) = (a(:,:,:,1,2).*a(:,:,:,2,3).*a(:,:,:,4,4) - a(:,:,:,1,2).*a(:,:,:,2,4).*a(:,:,:,4,3) - a(:,:,:,1,3).*a(:,:,:,2,2).*a(:,:,:,4,4) + a(:,:,:,1,3).*a(:,:,:,2,4).*a(:,:,:,4,2) ...
    + a(:,:,:,1,4).*a(:,:,:,2,2).*a(:,:,:,4,3) - a(:,:,:,1,4).*a(:,:,:,2,3).*a(:,:,:,4,2) )./det  ;

B(:,:,:,2,3) = -(a(:,:,:,1,1).*a(:,:,:,2,3).*a(:,:,:,4,4) - a(:,:,:,1,1).*a(:,:,:,2,4).*a(:,:,:,4,3) - a(:,:,:,1,3).*a(:,:,:,2,1).*a(:,:,:,4,4) + a(:,:,:,1,3).*a(:,:,:,2,4).*a(:,:,:,4,1) ... 
    + a(:,:,:,1,4).*a(:,:,:,2,1).*a(:,:,:,4,3) - a(:,:,:,1,4).*a(:,:,:,2,3).*a(:,:,:,4,1) )./det  ;

B(:,:,:,3,3) = (a(:,:,:,1,1).*a(:,:,:,2,2).*a(:,:,:,4,4) - a(:,:,:,1,1).*a(:,:,:,2,4).*a(:,:,:,4,2) - a(:,:,:,1,2).*a(:,:,:,2,1).*a(:,:,:,4,4) + a(:,:,:,1,2).*a(:,:,:,2,4).*a(:,:,:,4,1) ... 
    + a(:,:,:,1,4).*a(:,:,:,2,1).*a(:,:,:,4,2) - a(:,:,:,1,4).*a(:,:,:,2,2).*a(:,:,:,4,1) )./det ;

B(:,:,:,3,4) = -(a(:,:,:,1,1).*a(:,:,:,2,2).*a(:,:,:,4,3) - a(:,:,:,1,1).*a(:,:,:,2,3).*a(:,:,:,4,2) - a(:,:,:,1,2).*a(:,:,:,2,1).*a(:,:,:,4,3) + a(:,:,:,1,2).*a(:,:,:,2,3).*a(:,:,:,4,1) ...
    + a(:,:,:,1,3).*a(:,:,:,2,1).*a(:,:,:,4,2) - a(:,:,:,1,3).*a(:,:,:,2,2).*a(:,:,:,4,1) )./det ;

B(:,:,:,1,4) = -(a(:,:,:,1,2).*a(:,:,:,2,3).*a(:,:,:,3,4) - a(:,:,:,1,2).*a(:,:,:,2,4).*a(:,:,:,3,3) - a(:,:,:,1,3).*a(:,:,:,2,2).*a(:,:,:,3,4) + a(:,:,:,1,3).*a(:,:,:,2,4).*a(:,:,:,3,2) ...
    + a(:,:,:,1,4).*a(:,:,:,2,2).*a(:,:,:,3,3) - a(:,:,:,1,4).*a(:,:,:,2,3).*a(:,:,:,3,2) )./det ;

B(:,:,:,2,4) = (a(:,:,:,1,1).*a(:,:,:,2,3).*a(:,:,:,3,4) - a(:,:,:,1,1).*a(:,:,:,2,4).*a(:,:,:,3,3) - a(:,:,:,1,3).*a(:,:,:,2,1).*a(:,:,:,3,4) + a(:,:,:,1,3).*a(:,:,:,2,4).*a(:,:,:,3,1) ...
    + a(:,:,:,1,4).*a(:,:,:,2,1).*a(:,:,:,3,3) - a(:,:,:,1,4).*a(:,:,:,2,3).*a(:,:,:,3,1) )./det ;

B(:,:,:,3,4) = -(a(:,:,:,1,1).*a(:,:,:,2,2).*a(:,:,:,3,4) - a(:,:,:,1,1).*a(:,:,:,2,4).*a(:,:,:,3,2) - a(:,:,:,1,2).*a(:,:,:,2,1).*a(:,:,:,3,4) + a(:,:,:,1,2).*a(:,:,:,2,4).*a(:,:,:,3,1) ... 
    + a(:,:,:,1,4).*a(:,:,:,2,1).*a(:,:,:,3,2) - a(:,:,:,1,4).*a(:,:,:,2,2).*a(:,:,:,3,1) )./det ;

B(:,:,:,4,4) = (a(:,:,:,1,1).*a(:,:,:,2,2).*a(:,:,:,3,3) - a(:,:,:,1,1).*a(:,:,:,2,3).*a(:,:,:,3,2) - a(:,:,:,1,2).*a(:,:,:,2,1).*a(:,:,:,3,3) + a(:,:,:,1,2).*a(:,:,:,2,3).*a(:,:,:,3,1) ...
    + a(:,:,:,1,3).*a(:,:,:,2,1).*a(:,:,:,3,2) - a(:,:,:,1,3).*a(:,:,:,2,2).*a(:,:,:,3,1) )./det ;


%  inv(I-U*X)*X
for ii=1:4
  for jj=ii:4
      C(:,:,:,ii,jj) = 0;
   for l=1:4
      C(:,:,:,ii,jj) = C(:,:,:,ii,jj) + B(:,:,:,ii,l).*X(:,:,:,l,jj);
   end
  end
end

C(:,:,:,2,1) = C(:,:,:,1,2);
C(:,:,:,3,1) = C(:,:,:,1,3);
C(:,:,:,3,2) = C(:,:,:,2,3);
C(:,:,:,4,1) = C(:,:,:,1,4);
C(:,:,:,4,2) = C(:,:,:,2,4);
C(:,:,:,4,3) = C(:,:,:,3,4);





